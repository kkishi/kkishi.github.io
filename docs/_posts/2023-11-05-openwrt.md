---
layout: post
title: OpenWRT
---

## 背景

Deco M9が去年の暮れごろから正常に動作しなくなった。具体的には、

* ネットワークアドレスを`10.0.0.0`としたのに、勝手に`196.168.1.0`に変更された。
* ポート`80`と`443`をリバースプロキシ（Traefik）にポートフォワードしていたのだが、なぜか動作しなくなった。他のポートは動作する。

このためDecoをブリッジモードで動作させてルーターを他に導入することを考えた。中古のルーターをRicardoで探すと30~40CHFほどとそれほど安くなく、またプロプライエタリだと同様の問題に遭遇したときトラブルシューティングが大変なので、この機会にOpenWRTについて調べてみることにした。

OpenWRTは主に既存のルーターもしくはx86 PCにインストールされるようだ。最近買った中古PCがNICを２つ持っていたので、それをルーター化することにした。ただし、このPCはテレビにDisplayPortで接続したりストレージサーバーとして使ったりしていたので、それらも同時にサポートしたい。

## ベアメタル

まずはベアメタルで動作を確認することにした。<https://openwrt.org/docs/guide-user/installation/openwrt_x86>に従う。イメージは`openwrt-23.05.0-x86-64-generic-ext4-combined-efi.img.gz`を使用した。USBメモリに書き込むとそこからブートでき、コンソールに初期画面が表示された。どうやらNICのうち一つ(eth0)がルーターのLAN側としてセットアップされたようなので、そちらに他のPCを接続するとDHCPでIPアドレスが付与され、`192.168.1.1`にアクセスするとLuCIが表示された。WAN側がセットアップされていなかったが、もう一つのNIC(eth1)を使用して`Network > Interfaces > Add new interface`で以下のように設定できた。

* Name: wan
* Protocol: DHCP client
* Device: eth1

最終的には次のようなネットワーク構成となり、saginomiyaからインターネットに接続することができた。

```
   ┌────────────────┐
   │      Deco      │
   │ ┌────────────┐ │
   └─┤NIC:10.0.0.1├─┘
     └─────┬──────┘
    ┌──────┴───────┐
┌───┤eth1:10.0.0.13├─┐
│   └──────────────┘ │
│       ricardo      │
│ ┌────────────────┐ │
└─┤eth0:192.168.1.1├─┘
  └────────┬───────┘
  ┌────────┴────────┐
┌─┤NIC:192.168.1.201├─┐
│ └─────────────────┘ │
│      saginomiya     │
└─────────────────────┘
```

### Proxmox

次にProxmoxを用いてOpenWRTをVMとしてインストールする。

### Proxmoxのインストール

<https://internet.watch.impress.co.jp/docs/column/shimizu/1442466.html>を参考にした。GPUパススルーに関しても、今回はより一般的にPCIパススルーが必要となる（OpenWRTのWAN側NICをパススルーするため）ので参考となった。

`proxmox-ve_8.0-2.iso`を使用した。USBメモリに書き込み、改めてricardoにインストールする。コンソールに表示された`http://10.0.0.13:8006/`に接続するとProxmoxの管理画面が表示される。

現時点では以下のようなネットワーク図となる。

```
     ┌────────┐
     │  Deco  ├───────────────┐
     └────┬───┘               │
      ┌───┴──┐             ┌──┴──┐
┌─────┤enp3s0├──────┐ ┌────┤     ├────┐
│     └───┬──┘      │ │    └─────┘    │
│ ┌───────┴───────┐ │ │               │
│ │vmbr0:10.0.0.13│ │ │               │
│ └───────────────┘ │ │               │
└───────────────────┘ └───────────────┘
             proxmox        saginomiya
```

Proxmoxは`vmbr0`のような命名規則で仮想スイッチを生成する。初期状態では`vmbr0`のみがあり、NICのうち一つと関連付けされ、仮想スイッチ自体にDHCPでIPアドレスが付与される。そのIPアドレスはProxmoxの管理画面へアクセスするのに使用される。

新たに作成されたVMはデフォルトで`vmbr0`に接続される。以下例:

```
        ┌────────┐
        │  Deco  ├───────────────┐
        └───┬────┘               │
         ┌──┴───┐             ┌──┴──┐
┌────────┤enp3s0├──────┐ ┌────┤     ├────┐
│        └──┬───┘      │ │    └─────┘    │
│   ┌───────┴───────┐  │ │               │
│   │vmbr0:10.0.0.13│  │ │               │
│   └───────┬───────┘  │ │               │
│         ┌─┴──┐       │ └───────────────┘
│ ┌───────┤net0├─────┐ │       saginomiya
│ │       └─┬──┘     │ │
│ │ ┌───────┴──────┐ │ │
│ │ │eth0:10.0.0.14│ │ │
│ │ └──────────────┘ │ │
│ └──────────────────┘ │
│           ubuntu(vm) │
└──────────────────────┘
                proxmox
```

Proxmoxが一つのNICに複数のLAN IPアドレスを関連付けていることに注意。実際にsaginomiyaはこのアドレスに直接接続することができる。Proxmoxはこれを複数のMACアドレスを生成することで実現している。

### VT-dの有効化

PCIパススルーのために必要となる。使用しているマザーボードQ170M2の[マニュアル](https://dlcdnets.asus.com/pub/ASUS/mb/LGA1151/Q170M2-CDM-SI/E11313_Q170M2_CDM_SI_Guide_web_only_20170712.pdf)に従って、BIOSで`System Agent Configuration > VT-d`を有効化する。

有効化されていることを確認するには以下のページを参考にする。

<https://vfio.blogspot.com/2016/09/intel-iommu-enabled-it-doesnt-mean-what.html>

自分の場合はdmesgで`DMAR: Intel(R) Virtualization Technology for Directed I/O`と表示された。

### OpenWRTのインストール

以下のページを参考にした。

* <https://www.jwtechtips.top/how-to-install-openwrt-in-proxmox/>
* <https://i12bretro.github.io/tutorials/0405.html>
* <https://pve.proxmox.com/wiki/Manual:_qm.conf>


多少複雑な手順となる。まず理由を説明する。一般的なLinuxディストリビューションは主にインストールメディア経由でインストールされる。その場合、初回起動時にはVMは以下の状態となる。

* HDDは空である
* CDドライブにインストールメディアがマウントされている

インストーラーに従ってインストールが完了すると、HDDからブートできる状態となり、CDドライブは不要となる。

OpenWRTはインストールメディアは配布されておらず、ディスクイメージのみが配布されている。そのため初回起動時からHDDにデータを書き込みそこからブートする必要がある。これには以下の手順を踏む。VM IDは`101`と仮定する。

* Proxmoxのコンソールで`qm importdisk 101 /var/lib/vz/template/iso/openwrt-23.05.0-x86-64-generic-ext4-combined-efi.img local-lvm`と実行するとHDDが追加される。
* 新たに追加されたHDDがブートデバイスとして認識されるよう`/etc/pve/qemu-server/101.conf`を編集し`boot: order=scsi0`とする。

VMを起動するとベアメタルの場合と同様にNICがLAN側として設定された状態で起動する。アドレスは静的に`192.168.1.1`と設定される。この時点ではProxmoxのWAN側のNIC(enp3s0)にopenwrtのLAN側のNIC(net0)が接続されていることに注意。

```
             ┌────────┐
             │  Deco  ├───────────────┐
             └───┬────┘               │
              ┌──┴───┐             ┌──┴──┐
┌─────────────┤enp3s0├──────┐ ┌────┤     ├────┐
│             └──┬───┘      │ │    └─────┘    │
│        ┌───────┴───────┐  │ │               │
│        │vmbr0:10.0.0.13│  │ │               │
│        └───────┬───────┘  │ │               │
│              ┌─┴──┐       │ └───────────────┘
│ ┌────────────┤net0├─────┐ │       saginomiya
│ │            └─┬──┘     │ │
│ │ ┌────────────┴──────┐ │ │
│ │ │eth0:192.168.1.1/24│ │ │
│ │ └───────────────────┘ │ │
│ └───────────────────────┘ │
│                  openwrt  │
└───────────────────────────┘
                     proxmox
```

ここでもしLuCIを確認したい場合、openwrtのコンソールで`uci set network.lan.ipaddr='10.0.0.30'`と実行するとsaginomiyaからそのアドレスで接続することができる。ただし最終的には`192.168.1.1`に戻すこと。

次にもう一つのNIC(enp0s31f6s)に関連付けたvmbr1を導入し以下のようにしてsaginomiyaを接続する。LuCIでWAN側を適切に設定してProxmoxの管理画面にLAN側からも接続できるようにする。

```
             ┌────────┐
             │  Deco  │
             └───┬────┘
              ┌──┴───┐
┌─────────────┤enp3s0├──────┐
│             └──┬───┘      │
│        ┌───────┴───────┐  │
│        │vmbr0:10.0.0.13│  │
│        └───────┬───────┘  │
│              ┌─┴──┐       │
│ ┌────────────┤net1├─────┐ │
│ │            └─┬──┘     │ │
│ │     ┌────────┴─────┐  │ │
│ │     │eth1:10.0.0.14│  │ │
│ │     └──────────────┘  │ │
│ │ ┌───────────────────┐ │ │
│ │ │eth0:192.168.1.1/24│ │ │
│ │ └────────────┬──────┘ │ │
│ │            ┌─┴──┐     │ │
│ └────────────┤net0├─────┘ │
│  openwrt     └─┬──┘       │
│              ┌─┴───┐      │
│              │vmbr1│      │
│              └─┬───┘      │
│           ┌────┴─────┐    │
└───────────┤enp0s31f6s├────┘
 proxmox    └────┬─────┘
              ┌──┴──┐
         ┌────┤     ├────┐
         │    └─────┘    │
         └───────────────┘
               saginomiya
```

次にenp3s0をnet1にパススルーしたいが、するとProxmoxの管理画面に接続できなくなってしまうので、その前にvmbr1から接続できるようにする。具体的には以下:

* vmbr1のCIDRを`192.168.1.2/24`とする。これでLAN側からこのアドレスでProxmoxの管理画面に接続できるようになる。
* vmbr1のGatewayを`192.168.1.1`とする。これでProxmoxがOpenWRT経由でWANに接続できるようになる。

後はenp3s0とvmbr0をproxmoxから削除し、それに対応するNICをopenwrtにパススルーで追加すればよい(hostpci0)。

```
             ┌────────┐
             │  Deco  │
             └───┬────┘
              ┌──┴───┐
┌─────────────┤      ├──────┐
│             └──┬───┘      │
│           ┌────┴───┐      │
│ ┌─────────┤hostpci0├────┐ │
│ │         └────┬───┘    │ │
│ │       ┌──────┴─────┐  │ │
│ │       │eth1:x.x.x.x│  │ │
│ │       └────────────┘  │ │
│ │ ┌───────────────────┐ │ │
│ │ │eth0:192.168.1.1/24│ │ │
│ │ └────────────┬──────┘ │ │
│ │            ┌─┴──┐     │ │
│ └────────────┤net0├─────┘ │
│  openwrt     └─┬──┘       │
│    ┌───────────┴────────┐ │
│    │vmbr1:192.168.1.2/24│ │
│    └───────────┬────────┘ │
│           ┌────┴─────┐    │
└───────────┤enp0s31f6s├────┘
 proxmox    └────┬─────┘
              ┌──┴───┐
         ┌────┤      ├───┐
         │    └──────┘   │
         └───────────────┘
               saginomiya
```

### Deco M9のブリッジモード化

Decoのモバイルアプリから設定できる。以後はDecoのデバイスそれぞれがLAN内に独立したホストとして現れる。

Decoのアプリから自宅のDecoにはLANを経由せずにインターネット経由で接続することができる。これは普段は便利だが自宅のLANがインターネットに接続されていない場合に少し問題となる。スマートフォンがモバイルネットワークとWi-Fiのどちらも接続されている場合、Decoのアプリは必ずモバイルネットワークを優先するので、インターネット経由でDecoを探そうとするために接続できない。この場合はモバイルネットワークをオフにするとWi-Fi・LAN経由での接続を強制できる。

Decoのブリッジモードには落とし穴があって、デフォルトだとSmart DHCPという機能がOpenWRTのDHCPを上書きしてしまう。これは最新のファームウェア(1.6.2 Build 20230906 Rel. 78043)だとオフにできる。以下を参考のこと。

* <https://community.tp-link.com/en/home/forum/topic/160293>
* <https://community.tp-link.com/en/home/forum/topic/519144>

DHCPのトラブルシューティングには以下のページを参考にした。

<https://www.reddit.com/r/openwrt/comments/o3g9lb/dhcp_assigning_wrong_gateway_ip/>

以下のコマンドでDHCPクライアントがどのDHCPサーバーからIPをリースされているかを調べることができる。これでOpenWRT(192.168.1.1)ではなくDeco(192.168.1.248)からリースされていることがわかった。

`sudo dhclient -d -nw enp6s0f1`
